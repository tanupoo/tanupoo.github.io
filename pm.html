<!DOCTYPE html>
<html lang="ja">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width,initial-scale=1">
        <link rel="icon" href="data:,"> <!-- NOTE: Remove it for valid icon. -->
        <title>Rx Power Calculator</title>

<style>

label.t2 {
    margin: 4px;
}
label.t3 {
    margin: 4px;
}
label:not([class]) {
    font-weight: normal;
}
label:not([class]):after {
    content: ": "
}
input[type=text] {
    width: 50px;
    font-weight: bold;
    padding: 2px;
    margin: 2px;
}

.th_plm { /* thead of Packet Loss Models */
    font-weight: bold;
    padding: 6px;
}
.t2 {
    font-weight: bold;
    color: #505050;
}
.t3 {
    font-weight: normal;
    color: #505050;
}
.t4 {
    font-weight: bold;
    font-size: small;
}
.t5 {
    font-weight: bold;
    font-size: normal;
}
.box1 {
    width: 320px;
    border: 2px solid #414141;
    margin: 2px;
    padding: 2px;
}
.box2 {
    width: 314px;
    /*border-top: 1px solid #5b616b;*/
    margin: 0px;
}
.box3 {
    width: 314px;
    border-top: 1px solid #5b616b;
    margin: 4px;
}
.text-center {
    text-align: center;
}
.path_loss_use {
    background-color: #e7f4e4;
}
.canvas {
    height: 250px;
}

#title {
    font-size: large;
    font-weight: bold;
}
#table_path_loss_model {
    padding: 4px;
}
#base {
    display: flex;
    flex-wrap: wrap;
    border: 1px solid silver;
}
#box_estimation {
    background-color: rgb(255,228,242);
}
#box_fixed_path_loss {
    background-color: #e7f4e4;
}

</style>

    </head>

    <body>

        <div id="title">Rx Power Calculator</div>

        <div id="base" oninput="ev_change_rf_params()">

            <div class="box1">
                <div class="box3">
                    <label class="t2" for="box_tx_params">Tx Parameters</label>
                    <div>
                        <label for="freq">Frequency</label>
                        <input id="freq" type="text">MHz
                    </div>
                    <div>
                        <label for="box_tx_power">Tx Power</label>
                        <!-- XXX according to prod_dev -->
                        <span id="box_tx_power">
                            <span>
                                <input id="tx_power_dbm" type="text" oninput="ev_dbm_to_mw(this)">dBm
                            </span>
                            <span> &DoubleLeftRightArrow; </span>
                            <span>
                                <input id="tx_power_mw" type="text" oninput="ev_mw_to_dbm(this)">mW
                            </span>
                        </span>
                    </div>
                    <div>
                        <!-- XXX according to prod_ant -->
                        <label for="tx_ant_gain">Antenna Gain</label>
                        <input id="tx_ant_gain" type="text">dBi
                    </div>
                    <div>
                        <!-- XXX according to prod_cable -->
                        <label for="tx_cable_loss">Cable Loss</label>
                        <input id="tx_cable_loss" type="text">dB
                    </div>
                    <div>
                        <!-- XXX according to prod_misc -->
                        <label for="tx_misc_loss">Misc. Loss</label>
                        <input id="tx_misc_loss" type="text">dB
                    </div>
                    <div>
                        <label for="tx_ant_height">Height</label>
                        <input id="tx_ant_height" type="text">m
                    </div>
                </div>
                <div class="box3">
                    <div id="box_fixed_path_loss">
                        <!-- XXX enable it if "your estimation" is selected. -->
                        <label for="fixed_path_loss">Path Loss</label>
                        <input id="fixed_path_loss" type="text">dB
                        (<span class="t4">See *1</label>)
                    </div>
                    <div>
                        <label for="misc_loss">Misc. Loss</label>
                        <input id="misc_loss" type="text">dB
                    </div>
                </div>
                <div class="box3">
                    <label class="t2" for="box_rx_params">Rx Parameters</label>
                    <div id="box_rx_params">
                        <div>
                            <label for="rx_ant_gain">Antenna Gain</label>
                            <input id="rx_ant_gain" type="text">dBi
                        </div>
                        <div>
                            <label for="rx_cable_loss">Cable Loss</label>
                            <input id="rx_cable_loss" type="text">dB
                        </div>
                        <div>
                            <label for="rx_misc_loss">Misc. Loss</label>
                            <input id="rx_misc_loss" type="text">dB
                        </div>
                        <div>
                            <label for="rx_ant_height">Height</label>
                            <input id="rx_ant_height" type="text">m
                        </div>
                    </div>
                </div>
            </div>

            <div class="box1">
                <div class="box2">
                    <div class="box3">
                        <label for="dist_target">Distance</label>
                        <input id="dist_target" type="text">m
                    </div>
                    <div class="box3">
                        <label class="t2" for="box_estimation">Estimation</label>
                        <div id="box_estimation">
                            <div>
                                <label for="tx_erip_dbi">EIRP</label>
                                <span class="t5" id="tx_erip_dbi"></span> dBi
                                (<span id="tx_erip_mw"></span> mW)
                            </div>
                            <div>
                                <label for="rx_fresnel_r1">Fresnel R1</label>
                                <span class="t5" id="rx_fresnel_r1"></span> m
                            </div>
                            <div>
                                <label for="rx_fresnel_r1_60">60% of FR1</label>
                                <input class="t5" id="rx_fresnel_r1_60" type="text" disabled>m
                            </div>
                            <div>
                                <label for="rx_power">Rx Power</label>
                                <input class="t5" id="rx_power" type="text" disabled>dBm
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="box1">
                <label class="t2" for="box_path_loss_model_selector">Path Loss Model</label>
                <div class="box3" id="box_path_loss_model_selector">
                    <div id="box_path_loss_model">
                    </div>
                </div>
            </div>

            <div class="box1" id="box_chart_params">
                <div>
                    <input id="enable_chart_rx_power" type="checkbox">
                    <label class="t2" for="box_chart_params">Rx Power Chart</label>
                </div>
                <div class="box3" id="box_chart_distance">
                    <label class="t3" for="box_chart_distance">Distance Params.</label>
                    <div>
                        <label for="dist_min">Min. Dist.</label>
                        <input id="dist_min" type="text">m
                    </div>
                    <div>
                        <label for="dist_max">Max. Dist.</label>
                        <input id="dist_max" type="text">m
                    </div>
                    <div>
                        <label for="dist_interval">Dist. Inerval</label>
                        <input id="dist_interval" type="text">m
                    </div>
                </div>
                <div class="box3" id="box_chart_rx_power">
                    <label class="t3" for="box_chart_rx_power">Rx Power Params.</label>
                    <div>
                        <label for="rx_power_index1">Index</label>
                        <input id="rx_power_index1" type="text">dBm
                    </div>
                    <div>
                        <label for="rx_power_high">Power High</label>
                        <input id="rx_power_high" type="text">dBm
                    </div>
                    <div>
                        <label for="rx_power_low">Power Low</label>
                        <input id="rx_power_low" type="text">dBm
                    </div>
                    <div>
                        <label for="rx_power_step">Power Step</label>
                        <input id="rx_power_step" type="text">dBm
                    </div>
                </div>
            </div>
            </div>

        </div>

        <hr>
        <div class="canvas" id="canvas-path-loss"></div>

        <hr>
        <div id="info1"></div>
        <div id="info2"></div>

        <script src="https://cdn.jsdelivr.net/npm/plotly.js-dist-min@2.23.0/plotly.min.js" charset="utf-8"></script>
        <!--
        <script src="js/plotly/plotly-2.23.0.min.js" charset="utf-8"></script>
        -->

<script type="text/javascript" defer>

const minimum_canvas_width = 600;
const x_min_distance = 9.9;   // 10m
const significant_digit_base = 100; // 2

const default_rf_params = {
    'freq': 920,
    'tx_power_dbm': 13,
    'tx_cable_loss': 0,
    'tx_ant_gain': 5,
    'tx_ant_height': 10,
    'tx_misc_loss': 0,
    'misc_loss': 0,
    'rx_cable_loss': 0,
    'rx_ant_gain': 5,
    'rx_ant_height': 1,
    'rx_misc_loss': 0,
    'fixed_path_loss': 50,
    'dist_target': 800,
    'dist_min': 1,
    'dist_max': 1000,
    'dist_interval': 5,
    'rx_power_index1': -130,
    'rx_power_high': 50,
    'rx_power_low': -150,
    'rx_power_step': 20,
    };

const path_loss_models = [
    new pl_model_freespace(),
    new pl_model_hata_open(),
    new pl_model_hata_suburb(),
    new pl_model_hata_urban(),
    new pl_model_hata_urban_large(),
    new pl_model_fixed(),
    ];

///// main

var canvas_width = 0;
var current_model = '';

const canvas1 = document.getElementById('canvas-path-loss');
const info1 = document.getElementById('info1');
const info2 = document.getElementById('info2');

/*
init() -> redraw()
ev_resize() -> set_base_size() -> redraw()
ev_change_rf_params() -> redraw()
*/
init();

function set_base_size()
{
    //let height = `${window.innerHeight*.98}px`;
    document.getElementById('base').style.setProperty('width',
        `${window.innerWidth*.98}px`);

    // set canvas width
    if (window.innerWidth < 600) {
        canvas1.style.setProperty('width', minimum_canvas_width);
        canvas_width = minimum_canvas_width;
    } else {
        canvas1.style.setProperty('width', window.innerWidth*.98);
        canvas_width = window.innerWidth*.94;
    }
}

function round_base(v)
{
    return Math.round(v*significant_digit_base)/significant_digit_base;
}

function put_info1(m)
{
    info1.innerText = m;
}

function put_info2(m)
{
    info2.innerText = m;
}

function get_dbm_to_mw(dbm)
{
    let base = 10;
    let mw = Math.pow(10., (dbm/10.));
    return round_base(mw);
}

function get_mw_to_dbm(mw)
{
    let base = 10;
    let dbm = 10. * Math.log10(mw);
    return round_base(dbm);
}

function ev_dbm_to_mw()
{
    let dbm = parseFloat(document.getElementById('tx_power_dbm').value);
    document.getElementById('tx_power_mw').value = get_dbm_to_mw(dbm);
}

function ev_mw_to_dbm(e)
{
    let mw = parseFloat(document.getElementById('tx_power_mw').value);
    document.getElementById('tx_power_dbm').value = get_mw_to_dbm(mw);
}

function ev_change_rf_params()
{
    redraw();
}

function ev_resize()
{
    set_base_size();
    redraw();
}

function init_path_loss_models()
{
    /*
    make the below table for the path loss models.
   */
    let table = document.createElement('table');
    table.id = 'table_path_loss_model';
    let row, n, c;

    let thead = table.createTHead();
    row = thead.insertRow(0);
    // td 0: model name
    n = document.createElement('span');
    n.appendChild(document.createTextNode('model'));
    n.classList.add('th_plm');
    row.insertCell(-1).appendChild(n);
    // td 1: for estimation.
    n = document.createElement('span');
    n.appendChild(document.createTextNode('PL(*1)'));
    n.classList.add('th_plm');
    n.classList.add('path_loss_use');
    n.classList.add('text-center');
    row.insertCell(-1).appendChild(n);
    // td 2: for chart.
    n = document.createElement('span');
    n.appendChild(document.createTextNode('Chart'));
    n.classList.add('th_plm');
    row.insertCell(-1).appendChild(n);

    let tbody = table.createTBody();
    path_loss_models.forEach(x => {
        row = tbody.insertRow(-1);
        // td 0: model name
        n = document.createTextNode(x.model_name);
        row.insertCell(-1).appendChild(n);
        // td 1: for estimation.
        n = document.createElement('input');
        n.id = `pl_use_${x.label}`;
        n.type = 'radio';
        n.name = 'pl_model_use';
        n.x__model = x;
        n.checked = x.label == 'fixed' ? true : false;
        c = row.insertCell(-1);
        c.classList.add('path_loss_use');
        c.classList.add('text-center');
        c.appendChild(n);
        // td 2: for chart.
        n = document.createElement('input');
        n.id = `pl_chart_${x.label}`;
        n.type = 'checkbox';
        n.checked = x.label == 'fixed' ? false : true;
        c = row.insertCell(-1);
        c.classList.add('text-center');
        c.appendChild(n);
    });

    document.getElementById('box_path_loss_model').appendChild(table);
}

function init()
{
    set_base_size();
    init_path_loss_models();

    // set default RF params.
    Object.entries(default_rf_params).forEach(([k,v]) => {
        document.getElementById(k).value = v;
        });
    ev_dbm_to_mw();
    redraw();

    window.addEventListener('resize', ev_resize);
}

function get_rf_params()
{
    // read RF params.
    let params = {};
    Object.entries(default_rf_params).forEach(([k,v]) => {
        params[k] = parseFloat(document.getElementById(k).value);
        });
    return params;
}

function pl_model_fixed()
{
    this.model_name = 'Fixed PL';
    this.label = 'fixed';

    this.get_path_loss = function(p, d) {
        return parseFloat(document.getElementById('fixed_path_loss').value);
    };
}

function pl_model_freespace()
{
    /*
    Free-space path loss
    https://en.wikipedia.org/wiki/Free-space_path_loss

    FSPL = 20*log10(d) + 20*log10(f) - 27.55

    FSPL(dB)
    d(m)
    f(MHz)
     */
    this.model_name = 'Free Space';
    this.label = 'free_space';

    this.get_path_loss = function(p, d) {
        return 20.*Math.log10(d) + 20.*Math.log10(p.freq) - 27.55;
    };
}

/*
Okumura-Hata model
[1] https://en.wikipedia.org/wiki/Hata_model
[2] https://www.cdt21.com/technical_tools/okumura-hata-curve/
[3] https://www.gaussianwaves.com/2019/03/hata-okumura-model-for-outdoor-propagation/

Note:

the formulars in each reference are slightly different.
Need to check the original paper.
For example,
The frequency boundary for a large city is 200 in [1],[3], but 400 in [2].
The last value of the formula is 40.94 in [1],[2], but 40.98 in [3].
The valid communication range is [1km, 20km] in [2],[3], but [1km, 10km] in [1].
*/

function get_pl_hata(env_type, params, distance)
{
    /*
    env_type: [ 'urban', 'large-urban', 'suburb', 'open']
    return: { name: '...', x: [...], y: [...] }

    This function is implemented based on [2].

    PL = A + B*log10(d) - a + C
    A = 69.55 + 26.16*log10(f) - 13.82*log10(hB)
    B = 44.9 - 6.55*log10(hB)
    open:
        a = (1.1*log10(f) - 0.7)*hM - (1.56*log10(f) - 0.8)
        C = -4.78*(log10(f)**2) + 18.33*log10(f) - 40.94
    suburb:
        a = (1.1*log10(f) - 0.7)*hM - (1.56*log10(f) - 0.8)
        C = -2*(log10(f/28)**2) - 5.4
    small or medium-sized city:
        a = (1.1*log10(f) - 0.7)*hM - (1.56*log10(f) - 0.8)
        C = 0
    large city, f:[150, 400]:
        a = 8.29*(log10(1.54*hM)**2) - 1.1
        C = 0
    large city, f:[400, 1500]:
        a = 3.2*(log10(11.75*hM)**2) - 4.97
        C = 0

    f: frequency (MHz): [150, 1500]
    d: distance (m): [1000, 20000]
    hB: Ant height of Base station (m): [30, 200]
    hM: Ant height of Mobile device (m): [1, 10]
    */
    let p = params;
    let d = distance/1000;
    let f = p.freq;
    let hB = p.tx_ant_height;
    let hM = p.rx_ant_height;
    let log10 = Math.log10

    const info_suffix = ' for HATA model. (circuitdesign)';
    put_info2('The valid distance of HATA model is longer than 1000(m).');

    if (f < 150 || f > 1500) {
        put_info1('invalid frequency' + info_suffix);
    }
    if (hB < 30 || hB > 200) {
        put_info1('invalid height of Tx antenna' + info_suffix);
    }
    if (hM < 1 || hM > 10) {
        put_info1('invalid height of Rx antenna' + info_suffix);
    }

    let log10f = log10(f);
    let A = 69.55 + 26.16*log10f - 13.82*log10(hB)
    let B = 44.9 - 6.55*log10(hB)

    if (env_type == 'open') {
        a = (1.1*log10f - 0.7)*hM - (1.56*log10f - 0.8);
        C = -4.78*(log10f**2) + 18.33*log10f - 40.94;
    } else if (env_type == 'suburb') {
        a = (1.1*log10f - 0.7)*hM - (1.56*log10f - 0.8);
        // log10(f/28)**2
        C = -2*((log10f - log10(28))**2) - 5.4;
    } else if (env_type == 'urban') {
        // small or medium-size
        a = (1.1*log10f - 0.7)*hM - (1.56*log10f - 0.8);
        C = 0;
    } else if (env_type == 'urban-large') {
        if (f <= 400) {
            a = 8.29*(log10(1.54*hM)**2) - 1.1;
            C = 0;
        } else {
            a = 3.2*(log10(11.75*hM)**2) - 4.97;
            C = 0;
        }
    } else {
        alert(`unknown ${env_type}`);
    }

    return A + B*log10(d) - a + C;
}

function pl_model_hata_open()
{
    this.model_name = 'HATA Open';
    this.label = 'hata_open';
    this.get_path_loss = function(p, d) {
        return get_pl_hata('open', p, d);
    };
}

function pl_model_hata_suburb()
{
    this.model_name = 'HATA Suburb';
    this.label = 'hata_suburb';
    this.get_path_loss = function(p, d) {
        return get_pl_hata('suburb', p, d);
    };
}

function pl_model_hata_urban()
{
    this.model_name = 'HATA Mid City';
    this.label = 'hata_mid_city';
    this.get_path_loss = function(p, d) {
        return get_pl_hata('urban', p, d);
    };
}

function pl_model_hata_urban_large()
{
    this.model_name = 'HATA Large City';
    this.label = 'hata_large_city';
    this.get_path_loss = function(p, d) {
        return get_pl_hata('urban-large', p, d);
    };
}

function get_tx_erip(params)
{
    /* return: dBi */
    let p = params;
    return p.tx_power_dbm - p.tx_cable_loss - p.tx_misc_loss + p.tx_ant_gain;
}

function get_rx_power(model, params, distance)
{
    let p = params;
    let PL = model.get_path_loss(p, distance);
    let rxp = get_tx_erip(params) - PL + p.rx_ant_gain - p.rx_misc_loss - p.rx_cable_loss;
    return round_base(rxp);
}

function get_rx_power_curve(model, params)
{
    /*
     * return: data[name, x, y]
     */
    let data = {
        name: model.model_name,
        x: [],
        y: [],
    };
    for (let d = 0.001; d < params.dist_max; d+= params.dist_interval) {
        data.x.push(d);
        let power = get_rx_power(model, params, d);
        data.y.push(power);
    }
    return data;
}

function get_fresnel_zone_r1()
{
    /*
    https://en.wikipedia.org/wiki/Fresnel_zone
    F1 = 8.656 * sqr(D/f)
    F1: 1st Fresnel zone (m)
    D: distance between the two antenna (km)
    f: frequency (GHz)
    */
    let p = get_rf_params();
    let r1 = 8.656*Math.sqrt(p.dist_target/p.freq);
    return round_base(r1);
}

function draw_rx_power()
{
    let p = get_rf_params();
    let lines = [];

    path_loss_models.forEach(x => {
        let e = document.getElementById(`pl_chart_${x.label}`);
        if (e.checked === true) {
            lines.push(get_rx_power_curve(x, p));
        }
    });

    // target distance (vertical line)
    if (p.dist_target > x_min_distance) {
        // ignore it if the target distance is less than x_min_distance.
        let x_min_index = -1;
        for (let j = 0; j < lines[0].x.length; j++) {
            if (lines[0].x[j] > x_min_distance) {
                x_min_index = j;
                break;
            }
        }
        //if (x_min_index != -1) {
        if (1) {
            x_min_index = 0;
            let y_max = -99999;
            let y_min = 99999;
            if (!isNaN(p.rx_power_high)) {
                y_max = p.rx_power_high;
            }
            if (!isNaN(p.rx_power_low)) {
                y_min = p.rx_power_low;
            }
            for (let i = 0; i < lines.length; i++) {
                for (let j = x_min_index; j < lines[i].y.length; j++) {
                    if (y_max < lines[i].y[j]) {
                        y_max = lines[i].y[j];
                    }
                    if (y_min > lines[i].y[j]) {
                        y_min = lines[i].y[j];
                    }
                }
            }
            let data = {
                name: 'index distance',
                x: [p.dist_target, p.dist_target],
                y: [y_min, y_max],
                line: {
                    width: 1,
                    dash: 'dot',
                    color: 'rgb(230, 0, 0)',
                },
            };
            lines.push(data);
        } else {
            alert("FATAL: distance is something wrong.");
        }
    }

    // Rx power index (horizontal line)
    if (!isNaN(p.rx_power_index1)) {
        let data = {
            name: 'index strength',
            x: [],
            y: [],
            line: {
                width: 1,
                dash: 'dot',
                color: 'rgb(230, 0, 0)',
            },
        };
        for (let d = 0.001; d < p.dist_max; d+= p.dist_interval) {
            data.x.push(d);
            data.y.push(p.rx_power_index1);
        }
        lines.push(data);
    }

    // x axis
    let x_range = undefined;
    let x_autorange = true;
    if (!isNaN(p.dist_min) || !isNaN(p.dist_max)) {
        x_range = [p.dist_min, p.dist_max];
        x_autorange = false;
    }

    // y axis
    let y_range = undefined;
    let y_autorange = true;
    if (!isNaN(p.rx_power_low) || !isNaN(p.rx_power_high)) {
        y_range = [p.rx_power_low, p.rx_power_high];
        x_autorange = false;
    }
    let y_autotick = true;
    let y_dtick = undefined;
    if (isNaN(p.rx_power_step) !== true) {
        y_autotick = false;
        y_dtick = p.rx_power_step;
    }

    let layout = {
        title: 'Rx Power Chart',
        xaxis: {
            title: 'Distance (m)',
            range: x_range,
            autorange: x_autorange,
            showgrid: true,
            zeroline: true,
        },
        yaxis: {
            title: 'Rx Power (dBm)',
            range: y_range,
            autorange: y_autorange,
            showgrid: true,
            zeroline: true,
            autotick: y_autotick,
            dtick: y_dtick,
        },
        width: canvas_width,
        height: 600,
    };

    // XXX how to react ??
    Plotly.newPlot(canvas1, lines, layout)
        .catch(function(e){console.log('err2:', e)});
}

function set_rf_estimation()
{
    let params = get_rf_params();

    // find the model to be used.
    let e = document.getElementsByName('pl_model_use');
    let model = undefined;
    for(i = 0; i < e.length; i++) {
        if(e[i].checked) {
            model = e[i].x__model;
            break;
        }
    }
    if (model === undefined) {
        //alert("FATAL: Invalid Path Loass Model is selected.");
        return;
    }

    // set Path Loss value if needed.
    e = document.getElementById('fixed_path_loss');
    if (model.label != 'fixed') {
        e.disabled = true;
        e.value = round_base(model.get_path_loss(params, params.dist_target));
        current_model = model.label;
    } else {
        e.disabled = false;
        if (current_model != 'fixed') {
            e.value = default_rf_params.fixed_path_loss;
            current_model = 'fixed';
        }
    }

    let erip = get_tx_erip(params);
    document.getElementById('tx_erip_dbi').innerText = erip;
    document.getElementById('tx_erip_mw').innerText = get_dbm_to_mw(erip);

    let rxp = get_rx_power(model, params, params.dist_target);
    document.getElementById('rx_power').value = rxp;

    let fr1 = get_fresnel_zone_r1();
    document.getElementById('rx_fresnel_r1').innerText = fr1;
    document.getElementById('rx_fresnel_r1_60').value = round_base(fr1*0.6);
}

function redraw()
{
    set_rf_estimation();
    if (document.getElementById('enable_chart_rx_power').checked === true) {
        document.getElementById('box_chart_distance').style.display = 'block';
        document.getElementById('box_chart_rx_power').style.display = 'block';
        draw_rx_power();
    } else {
        document.getElementById('box_chart_distance').style.display = 'none';
        document.getElementById('box_chart_rx_power').style.display = 'none';
        Plotly.purge(canvas1);
    }
}

</script>

    </body>
</html>
